<!-- HEADER -->
<div class="heading d-flex justify-content-center align-items-center w-100 pt-2">
  <div class="pg-title">
    <% if @user.is_business? && @user.owned_place.present? %>
      <h5> <strong><%= @user.owned_place.name %> </strong> </h5>
    <% else %>
      <h5> <strong>Olá, <%= @user.first_name %> </strong> </h5>
    <% end %>
  </div>
</div>

<!-- MAIN BODY -->

<!-- AVATAR -->
<div class="d-flex justify-content-center pt-5 mt-4">
  <%= cl_image_tag current_user.photo.key, class:"avatar", transformation: [{width: 400, height: 400, gravity: "face", radius: "max", crop: "crop", quality: 80}, {width: 150, crop: "scale"}] %>
</div>
<br>

<!-- EDIT AND LOGOUT -->
<div class="row">
  <div class="col-12">
    <%= link_to 'Editar perfil', edit_user_registration_path, class: "d-flex justify-content-center" %>
  </div>
  <div class="col-12 dropdown-divider"></div>
  <div class="col-12">
    <%= link_to 'Sair', destroy_user_session_path, method: :delete, class: "d-flex justify-content-center pb-5" %>
  </div>
</div>

<!-- BUSINESS PROFILE -->
<% if @user.is_business %>
  <!-- HAS PLACE -->
  <% if @user.owned_place.present? %>
    <div class="accordion" id="business">
      <!-- AWAITING RESPONSE -->
      <div class="card">
        <div class="card-header" id="awaiting">
          <h2 class="mb-0">
            <!--<button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#awaitingCollapse" aria-expanded="true" aria-controls="awaitingCollapse">
              Avaliações aguardando resposta
            </button>-->
          </h2>
        </div>

        <div id="awaitingCollapse" class="collapse" aria-labelledby="awaiting" data-parent="#business">
          <div class="card-body">
            <% if @user.owned_place.reviews.present? %>
              <ul>
                <% @user.owned_place.reviews.order(updated_at: :desc).each do |review| %>
                  <% if review.responses.present? && review.responses.last.user != current_user %>
                    <li><i class="fas fa-comments"></i> <%= link_to review.title, review_path(review) %> </li>
                  <% else %>
                    <p>Não há avaliações aguardando resposta.</p>
                  <% end %>
                <% end %>
              </ul>
            <% else %>
              <p>Ainda não foi realizada nenhuma avaliação.</p>
            <% end %>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" id="allReviews">
          <h2 class="mb-0">
            <button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#allReviewsCollapse" aria-expanded="false" aria-controls="allReviewsCollapse">
              Todas as avaliações do meu estabelecimento
            </button>
          </h2>
        </div>
        <div id="allReviewsCollapse" class="collapse" aria-labelledby="allReviews" data-parent="#business">
          <div class="card-body">
            <% if @user.owned_place.reviews.present? %>
              <ul>
                <% @user.owned_place.reviews.each do |review| %>
                  <% if review.responses.present? && review.responses.last.user != current_user %>
                    <li><i class="fas fa-comments"></i> <%= link_to review.title, review_path(review) %> </li>
                  <% else %>
                    <li> <%= link_to review.title, review_path(review) %> (<%= link_to review.place.name, place_path(review.place) %>)</li>
                  <% end %>
                <% end %>
              </ul>
            <% else %>
              Nenhuma avaliação
            <% end %>
          </div>
        </div>
      </div>
    </div>
  
  <!-- NEED TO SELECT OR ADD PLACE -->
  <% else %>
    <div class="accordion" id="newBusiness">
      <div class="card">
        <div class="card-header" id="registered">
          <h2 class="mb-0">
            <button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#registeredCollapse" aria-expanded="true" aria-controls="registeredCollapse">
              Meu estabelecimento já está cadastrado na plataforma
            </button>
          </h2>
        </div>
        <div id="registeredCollapse" class="collapse" aria-labelledby="registered" data-parent="#newBusiness">
          <div class="card-body">
            <div class="d-flex justify-content-center">
              <%= simple_form_for :owner, url: add_owner_path, method: "patch" do |f| %>
                <%= f.input :place, as: :select, collection: @places, label: "Selecionar estabelecimento" %>
                <%= f.submit 'Adicionar esse estabelecimento', data: { confirm: 'O estabelecimento selecionado está correto?' }, class: "btn btn-sm btn-primary btns" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" id="newPlace">
          <h2 class="mb-0">
            <button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#newPlaceCollapse" aria-expanded="false" aria-controls="newPlaceCollapse">
              Adicionar meu estabelecimento à Ollivia!
            </button>
          </h2>
        </div>
        <div id="newPlaceCollapse" class="collapse" aria-labelledby="newPlace" data-parent="#newBusiness">
          <div class="card-body">
            <%= link_to new_place_path, class: "btn btn-sm btn-primary btns d-flex justify-content-center" do %>
              <i class="fas fa-building"></i>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

<!-- COMMON PROFILE -->
<% else %>
  <div class="accordion" id="commom">
    <div class="card">
      <div class="card-header" id="angels">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#angelsCollapse" aria-expanded="true" aria-controls="angelsCollapse">
            Meus anjos
          </button>
        </h2>
      </div>
      <div id="angelsCollapse" class="collapse" aria-labelledby="angels" data-parent="#commom">
        <div class="card-body">
          <ul class="list-group m-3">
            <% if @user.angels %>
              <% @user.angels.each do |angel| %>
                <li class="list-group-item d-flex justify-content-center"><%= link_to angel.first_name, angel_path(angel) %></li>
              <% end %>
            <% end %>
          </ul>
          <%= link_to "Adicionar novo anjo", new_angel_path, class: "btn btn-sm btn-primary btns d-flex justify-content-center" %>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header" id="reviews">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed title table page-item d-flex justify-content-center pt-3" type="button" data-toggle="collapse" data-target="#reviewsCollapse" aria-expanded="false" aria-controls="reviewsCollapse">
            Minhas avaliações
          </button>
        </h2>
      </div>
      <div id="reviewsCollapse" class="collapse" aria-labelledby="reviews" data-parent="#commom">
        <div class="card-body">
          <ul>
            <% @user.reviews.each do |review| %>
              <% if review.responses.present? && review.responses.last.user != current_user %>
                <li><i class="fas fa-comments"></i> <%= link_to review.title, review_path(review) %> (<%= link_to review.place.name, place_path(review.place) %>)</li>
              <% else %>
                <li> <%= link_to review.title, review_path(review) %> (<%= link_to review.place.name, place_path(review.place) %>)</li>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
<% end %>
