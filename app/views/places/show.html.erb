<!--header-->
<div class="heading d-flex justify-content-between align-items-center w-100">
  <div class="back-btn text-white ml-2">
    <%= link_to :back do %>
      <i class="fas fa-arrow-left"></i>
    <% end %>
  </div>
  <div class="pg-title">
    <%= @place.name %>
  </div>
  <div>
  </div>
</div>
<!--fim do header-->
<div>
  <div>
    <div class="img-show">
      <%= cl_image_tag @place.photo.key %>
    </div>
    <div class="review-content">
      <div class="review-ranking">
        <% if @place.reviews.length == 0 %>
          <span>"Local sem avaliações. Deixe sua opinião"</span>
        <% else %>
          <!-- RATING SYSTEM -->
          <div class="rating-container">
            <div class="rates-outer">
              <div class="rates-inner">
              </div>
            </div>
            <span class="number-rating"><%= @place.average_rating.round(1) %></span>
          </div>
        <% end %>
        <span class="txt-rating">Ranking Ollivia</span>
      </div>
      <div class="review-header mt-3 pt-4 pb-2 px-4 border-bottom">
        <div class='place-info'>
          <h2 class="purple"><%= @place.name %></h2>
          <p><%= @place.description %></p>
          <% if @place.reviews.length > 0 %>
            <p class="sm-line"><strong class="purple"><%= @place.reviews.length %></strong> relatos </p>
          <% end %>
        </div>
      </div>
      <div class="review-buttons d-flex justify-content-around m-4">
        <!-- linkar após criarmos a rota -->
        <div class="xp-btn">
          <div class="xp-btn-thumb">
            <i class="far fa-thumbs-up"></i>
          </div>
          <div class="xp-btn-content">
            Experiência boa
          </div>
        </div>
        <!-- linkar após criarmos a rota -->
        <div class="xp-btn">
          <div class="xp-btn-thumb">
            <i class="far fa-thumbs-down"></i>
          </div>
          <div class="xp-btn-content">
            Experiência ruim
          </div>
        </div>
      </div>
      <% @reviews.where("is_disabled = ?", false).each do |review| %>
        <div class="review-card">
          <div class="review-header m-3">
            <% if review.is_anonymous %>
              <!-- avatar anonimo -->
              <p>Por: usuário anônimo</p>
              <%= link_to review.title, review_path(review) %>
            <% else %>
              <%= cl_image_tag review.user.photo.key, class:"avatar-mini", transformation: [{width: 400, height: 400, gravity: "face", radius: "max", crop: "crop", quality: 80}, {width: 150, crop: "scale"}] %>
              <%= link_to review.title, review_path(review), class: "ml-1" %>
              <p class="ml-5 purple sm-line">Por <%= review.user.username %></p>
            <% end %>
          </div>
          <div class="review-content m-4 border-bottom">
            <% if review.content.chars.length > 121 %>
              <p><%= review.content.slice(0, 120) + '...' %></p>
            <% else %>
              <p> <%= review.content %></p>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @review.responses %>
        <div class="response-card">
          <div class="response-header">
          </div>
          <div class="response-content">
          </div>
        </div>
      <% end %>
    </div>
    <% if policy(@place).edit? %>
      <p><%= link_to 'editar local', edit_place_path(@place), class: "pink-btn" %></p>
    <% end %>
    <% if policy(@place).add_review? %>
      <div>
        <p>Nos conte sobre a sua experiência:</p>
        <%= simple_form_for [@place, @review], method: 'post' do |f| %>
          <div>
            <%# LABEL + INPUTS IS_GOOD  %>
            <%= f.label "Como foi sua experiência?" %>
            <%= f.collection_radio_buttons :is_good,
                                        [
                                          [true, 'Boa'],
                                          [false, 'Ruim']
                                        ],
                                        :first,
                                        :last,
                                        checked: true,
                                        item_wrapper_class: :evaluation,
                                        item_wrapper_tag: :p %>
            <%= f.input :title, label: "Título" %>
            <%= f.input :content %>
            <%= f.input :rating, collection: (0..5).to_a, selected: 0 %>
            <fieldset class="form-group" id="anonymous" style="display:none;">
              <%= f.input :is_anonymous, label: "Você gostaria de permanecer anônima?" %>
            </fieldset>
            <%= f.submit 'Avaliar' %>
          </div>
        <% end %>
      </div>
    <% else %>
      <%= link_to 'Faça login para avaliar o local', new_user_session_path unless current_user.present? && current_user.is_business %>
    <% end %>
    <p><%= link_to 'Voltar a Locais', places_path %></p>
  </div>
  <!-- JS SCRIPT PARA RATING CUSTOMIZADO -->
  <script>
    // Rating
    const rating = <%= @place.average_rating.round(1) %>
    console.log(rating)
    // Total icons
    const iconTotal =5;
    
    // Run getRating when DOM loads
    document.addEventListener('DOMContentLoaded', getRating);
    
    // Get rating
    function getRating() {
      // Get percentage
      const iconPercentage = (rating / iconTotal) * 100;
      console.log(iconPercentage)
      // Round to nearest
      const iconPercentageRounded = `${Math.round(iconPercentage / 10) * 10}%`;
      console.log(iconPercentageRounded)
      // Set width of rates-inner to percentage
      document.querySelector('.rates-inner').style.width = iconPercentageRounded;
    };
  </script>
